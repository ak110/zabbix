- hosts: all
  environment:
    http_proxy: "{{ lookup('env', 'http_proxy') }}"
    https_proxy: "{{ lookup('env', 'https_proxy') }}"
  tasks:
    - name: download .deb for Debian 9 (Stretch)
      get_url:
        url="http://repo.zabbix.com/zabbix/3.4/debian/pool/main/z/zabbix-release/zabbix-release_3.4-1+stretch_all.deb"
        dest=/tmp/zabbix.deb
      when: ansible_distribution == "Debian" and ansible_distribution_major_version|int == 9
    - name: download .deb for Ubuntu 16 (Xenial)
      get_url:
        url="http://repo.zabbix.com/zabbix/3.4/ubuntu/pool/main/z/zabbix-release/zabbix-release_3.4-1+xenial_all.deb"
        dest=/tmp/zabbix.deb
      when: ansible_distribution == "Ubuntu" and ansible_distribution_major_version|int == 16
    - name: download .deb for Ubuntu 14 (Trusty)
      get_url:
        url="http://repo.zabbix.com/zabbix/3.4/ubuntu/pool/main/z/zabbix-release/zabbix-release_3.4-1+trusty_all.deb"
        dest=/tmp/zabbix.deb
      when: ansible_distribution == "Ubuntu" and ansible_distribution_major_version|int == 14
    - apt: deb=/tmp/zabbix.deb
      become: True
    - apt: name=zabbix-agent update_cache=yes
      become: True

    - copy: src=custom.conf dest=/etc/zabbix/zabbix_agentd.d/
      become: True
    - lineinfile: dest=/etc/zabbix/zabbix_agentd.conf regexp='^Hostname=' line='#Hostname=Zabbix server'
      become: True
    - lineinfile: dest=/etc/zabbix/zabbix_agentd.conf regexp='^Server=' line='Server=127.0.0.1,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16'
      become: True

